# RAG ä¸çŸ¥è¯†åº“ç³»ç»Ÿé›†æˆè¯´æ˜

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•ä½¿ç”¨ RAG æ¨¡å—ä¸ AIMemos ç°æœ‰çŸ¥è¯†åº“ç³»ç»Ÿçš„é›†æˆåŠŸèƒ½ã€‚

## æ¦‚è¿°

RAG é›†æˆæä¾›äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **è‡ªåŠ¨åŒæ­¥** â­ NEWï¼šæ–‡æ¡£åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æ—¶è‡ªåŠ¨æ›´æ–° RAG ç´¢å¼•
2. **æ‰‹åŠ¨ç´¢å¼•**ï¼šå°†çŸ¥è¯†åº“ä¸­çš„æ–‡æ¡£æ‰‹åŠ¨ç´¢å¼•åˆ°å‘é‡æ•°æ®åº“
3. **è¯­ä¹‰æœç´¢**ï¼šåŸºäºå‘é‡ç›¸ä¼¼åº¦çš„æ™ºèƒ½æœç´¢
4. **å¢é‡æ›´æ–°**ï¼šæ”¯æŒå•ä¸ªæ–‡æ¡£çš„é‡æ–°ç´¢å¼•
5. **æƒé™æ§åˆ¶**ï¼šé›†æˆç°æœ‰çš„ç”¨æˆ·æƒé™ç³»ç»Ÿ

> ğŸ’¡ **æ¨èä½¿ç”¨è‡ªåŠ¨åŒæ­¥åŠŸèƒ½**ï¼šæ–‡æ¡£å˜æ›´æ—¶è‡ªåŠ¨æ›´æ–°ç´¢å¼•ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨ APIã€‚è¯¦è§ [AUTO_SYNC.md](AUTO_SYNC.md)

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AIMemos FastAPI Application                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  API Endpoints (/api/v1/rag)                            â”‚
â”‚  â”œâ”€â”€ POST /index          - ç´¢å¼•çŸ¥è¯†åº“                   â”‚
â”‚  â”œâ”€â”€ POST /search         - è¯­ä¹‰æœç´¢                     â”‚
â”‚  â”œâ”€â”€ DELETE /index/{kb_id}- åˆ é™¤çŸ¥è¯†åº“ç´¢å¼•              â”‚
â”‚  â”œâ”€â”€ POST /reindex/document/{doc_id} - é‡æ–°ç´¢å¼•æ–‡æ¡£     â”‚
â”‚  â””â”€â”€ DELETE /index/document/{doc_id} - åˆ é™¤æ–‡æ¡£ç´¢å¼•     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           RAG Integration Layer (integration.py)        â”‚
â”‚  - è¿æ¥çŸ¥è¯†åº“æœåŠ¡å’Œæ–‡æ¡£æœåŠ¡                               â”‚
â”‚  - ç®¡ç†å‘é‡ç´¢å¼•ç”Ÿå‘½å‘¨æœŸ                                   â”‚
â”‚  - å®ç°æœç´¢å’Œè¿‡æ»¤é€»è¾‘                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                              â”‚
            â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Knowledge Base      â”‚      â”‚  RAG Core Modules        â”‚
â”‚  Services            â”‚      â”‚  - embeddings.py         â”‚
â”‚  - KnowledgeBase     â”‚      â”‚  - vector_store.py       â”‚
â”‚  - Document          â”‚      â”‚  - ingest.py             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                              â”‚
            â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQLite Database     â”‚      â”‚  Milvus Lite Vector DB   â”‚
â”‚  (aimemos.db)        â”‚      â”‚  (milvus_aimemos.db)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é›†æˆç»„ä»¶

### 1. RAG Integration (`rag/integration.py`)

æ ¸å¿ƒé›†æˆæ¨¡å—ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

- `index_document()` - ç´¢å¼•å•ä¸ªæ–‡æ¡£
- `index_knowledge_base()` - ç´¢å¼•æ•´ä¸ªçŸ¥è¯†åº“
- `search_in_knowledge_base()` - åœ¨æŒ‡å®šçŸ¥è¯†åº“ä¸­æœç´¢
- `search_all_knowledge_bases()` - åœ¨æ‰€æœ‰çŸ¥è¯†åº“ä¸­æœç´¢
- `delete_document_vectors()` - åˆ é™¤æ–‡æ¡£å‘é‡
- `delete_knowledge_base_vectors()` - åˆ é™¤çŸ¥è¯†åº“å‘é‡
- `reindex_document()` - é‡æ–°ç´¢å¼•æ–‡æ¡£

### 2. API Endpoints (`aimemos/api/v1/endpoints/rag.py`)

æä¾› RESTful API æ¥å£ï¼š

- `POST /api/v1/rag/index` - ç´¢å¼•çŸ¥è¯†åº“
- `POST /api/v1/rag/search` - è¯­ä¹‰æœç´¢
- `DELETE /api/v1/rag/index/{kb_id}` - åˆ é™¤çŸ¥è¯†åº“ç´¢å¼•
- `POST /api/v1/rag/reindex/document/{doc_id}` - é‡æ–°ç´¢å¼•æ–‡æ¡£
- `DELETE /api/v1/rag/index/document/{doc_id}` - åˆ é™¤æ–‡æ¡£ç´¢å¼•

## ä½¿ç”¨ç¤ºä¾‹

### 1. å¯åŠ¨ AIMemos åº”ç”¨

```bash
uv run aimemos
```

åº”ç”¨å°†åœ¨ `http://localhost:8000` å¯åŠ¨ã€‚

### 2. åˆ›å»ºç”¨æˆ·å’ŒçŸ¥è¯†åº“

ä½¿ç”¨ç°æœ‰çš„ API åˆ›å»ºç”¨æˆ·ã€çŸ¥è¯†åº“å’Œæ–‡æ¡£ï¼š

```bash
# æ³¨å†Œç”¨æˆ·
curl -X POST "http://localhost:8000/api/v1/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "testuser",
    "password": "testpass"
  }'

# ç™»å½•è·å– token
TOKEN=$(curl -s -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"user_id":"testuser","password":"testpass"}' | \
  python -c "import sys, json; print(json.load(sys.stdin)['access_token'])")

# åˆ›å»ºçŸ¥è¯†åº“
KB_ID=$(curl -s -X POST "http://localhost:8000/api/v1/knowledge-bases" \
  -H "Content-Type: application/json" \
  -H "Authorization: ******" \
  -d '{
    "name": "AI çŸ¥è¯†åº“",
    "description": "äººå·¥æ™ºèƒ½ç›¸å…³çŸ¥è¯†"
  }' | python -c "import sys, json; print(json.load(sys.stdin)['id'])")

# åˆ›å»ºæ–‡æ¡£
curl -X POST "http://localhost:8000/api/v1/documents?kb_id=$KB_ID" \
  -H "Content-Type: application/json" \
  -H "Authorization: ******" \
  -d '{
    "name": "äººå·¥æ™ºèƒ½ç®€ä»‹",
    "content": "äººå·¥æ™ºèƒ½ï¼ˆArtificial Intelligenceï¼Œç®€ç§°AIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯...",
    "summary": "ä»‹ç»äººå·¥æ™ºèƒ½çš„åŸºæœ¬æ¦‚å¿µ"
  }'
```

### 3. ç´¢å¼•çŸ¥è¯†åº“

```bash
# ç´¢å¼•æ•´ä¸ªçŸ¥è¯†åº“
curl -X POST "http://localhost:8000/api/v1/rag/index" \
  -H "Content-Type: application/json" \
  -H "Authorization: ******" \
  -d '{
    "kb_id": "'$KB_ID'",
    "max_tokens": 512,
    "overlap_tokens": 128
  }'
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "kb_id": "kb_xxx",
  "kb_name": "AI çŸ¥è¯†åº“",
  "total_documents": 5,
  "indexed_documents": 5,
  "skipped_documents": 0,
  "total_chunks": 12
}
```

### 4. è¯­ä¹‰æœç´¢

```bash
# åœ¨æŒ‡å®šçŸ¥è¯†åº“ä¸­æœç´¢
curl -X POST "http://localhost:8000/api/v1/rag/search" \
  -H "Content-Type: application/json" \
  -H "Authorization: ******" \
  -d '{
    "query": "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ",
    "kb_id": "'$KB_ID'",
    "top_k": 5
  }'

# åœ¨æ‰€æœ‰çŸ¥è¯†åº“ä¸­æœç´¢ï¼ˆä¸æŒ‡å®š kb_idï¼‰
curl -X POST "http://localhost:8000/api/v1/rag/search" \
  -H "Content-Type: application/json" \
  -H "Authorization: ******" \
  -d '{
    "query": "æ·±åº¦å­¦ä¹ çš„åº”ç”¨",
    "top_k": 10
  }'
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "query": "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ",
  "kb_id": "kb_xxx",
  "results": [
    {
      "content": "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é¢†åŸŸ...",
      "source": "æœºå™¨å­¦ä¹ åŸºç¡€",
      "score": 0.8765,
      "metadata": {
        "kb_id": "kb_xxx",
        "doc_id": "doc_yyy",
        "doc_type": "note",
        "doc_name": "æœºå™¨å­¦ä¹ åŸºç¡€",
        "user_id": "testuser",
        "chunk_index": 0
      }
    }
  ],
  "total": 5
}
```

### 5. æ–‡æ¡£æ›´æ–°åé‡æ–°ç´¢å¼•

```bash
# æ›´æ–°æ–‡æ¡£å†…å®¹
curl -X PUT "http://localhost:8000/api/v1/documents/$DOC_ID" \
  -H "Content-Type: application/json" \
  -H "Authorization: ******" \
  -d '{
    "content": "æ›´æ–°åçš„æ–‡æ¡£å†…å®¹..."
  }'

# é‡æ–°ç´¢å¼•æ–‡æ¡£
curl -X POST "http://localhost:8000/api/v1/rag/reindex/document/$DOC_ID" \
  -H "Authorization: ******"
```

### 6. åˆ é™¤ç´¢å¼•

```bash
# åˆ é™¤æ–‡æ¡£ç´¢å¼•
curl -X DELETE "http://localhost:8000/api/v1/rag/index/document/$DOC_ID" \
  -H "Authorization: ******"

# åˆ é™¤æ•´ä¸ªçŸ¥è¯†åº“çš„ç´¢å¼•
curl -X DELETE "http://localhost:8000/api/v1/rag/index/$KB_ID" \
  -H "Authorization: ******"
```

## Python ç¼–ç¨‹æ¥å£

ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ Python ä»£ç è°ƒç”¨é›†æˆæ¨¡å—ï¼š

```python
from rag.integration import create_rag_integration

# åˆ›å»ºé›†æˆå®ä¾‹
rag = create_rag_integration()

# ç´¢å¼•çŸ¥è¯†åº“
stats = rag.index_knowledge_base(
    user_id="testuser",
    kb_id="kb_xxx",
    show_progress=True
)
print(f"ç´¢å¼•äº† {stats['indexed_documents']} ä¸ªæ–‡æ¡£")

# æœç´¢
results = rag.search_in_knowledge_base(
    user_id="testuser",
    kb_id="kb_xxx",
    query="ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ",
    top_k=5
)

for result in results:
    print(f"- {result['source']}: {result['content'][:100]}...")

# å…³é—­è¿æ¥
rag.close()
```

## æ•°æ®æ¨¡å‹

### å‘é‡æ•°æ®åº“ Schema

```python
{
    "pk": int,                    # ä¸»é”®ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
    "embedding": List[float],     # 768ç»´å‘é‡ï¼ˆm3e-baseï¼‰
    "content": str,               # æ–‡æœ¬å—å†…å®¹
    "source": str,                # æ–‡æ¡£åç§°
    "metadata": {                 # å…ƒæ•°æ®
        "kb_id": str,            # çŸ¥è¯†åº“ ID
        "doc_id": str,           # æ–‡æ¡£ ID
        "doc_type": str,         # æ–‡æ¡£ç±»å‹ï¼ˆnote/uploadedï¼‰
        "doc_name": str,         # æ–‡æ¡£åç§°
        "user_id": str,          # ç”¨æˆ· ID
        "chunk_index": int       # å—ç´¢å¼•
    },
    "created_at": int             # åˆ›å»ºæ—¶é—´æˆ³
}
```

## æƒé™æ§åˆ¶

é›†æˆæ¨¡å—å®Œå…¨éµå¾ª AIMemos çš„æƒé™æ¨¡å‹ï¼š

1. **ç”¨æˆ·éš”ç¦»**ï¼šæ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„çŸ¥è¯†åº“å’Œæ–‡æ¡£
2. **çŸ¥è¯†åº“æƒé™**ï¼šé€šè¿‡ `kb_service.get_knowledge_base()` éªŒè¯æƒé™
3. **æ–‡æ¡£æƒé™**ï¼šé€šè¿‡ `doc_service.get_document()` éªŒè¯æƒé™
4. **å‘é‡è¿‡æ»¤**ï¼šæœç´¢æ—¶è‡ªåŠ¨æ·»åŠ  `user_id` è¿‡æ»¤æ¡ä»¶

## æœ€ä½³å®è·µ

### 1. ç´¢å¼•æ—¶æœº

- **æ–°å»ºçŸ¥è¯†åº“**ï¼šåˆ›å»ºçŸ¥è¯†åº“å¹¶æ·»åŠ æ–‡æ¡£åç«‹å³ç´¢å¼•
- **æ‰¹é‡å¯¼å…¥**ï¼šæ‰¹é‡å¯¼å…¥æ–‡æ¡£åç»Ÿä¸€ç´¢å¼•
- **æ–‡æ¡£æ›´æ–°**ï¼šæ›´æ–°æ–‡æ¡£å†…å®¹åè°ƒç”¨é‡æ–°ç´¢å¼•

### 2. æœç´¢ä¼˜åŒ–

- **æŒ‡å®šçŸ¥è¯†åº“**ï¼šå¦‚æœæ˜ç¡®çŸ¥é“æœç´¢èŒƒå›´ï¼ŒæŒ‡å®š `kb_id` å¯æé«˜æ€§èƒ½
- **åˆç†çš„ top_k**ï¼šé€šå¸¸ 5-10 ä¸ªç»“æœè¶³å¤Ÿï¼Œé¿å…è¿‡å¤§çš„ top_k
- **ç»“åˆä¼ ç»Ÿæœç´¢**ï¼šå‘é‡æœç´¢ä¸å…³é”®è¯æœç´¢ç»“åˆä½¿ç”¨æ•ˆæœæ›´å¥½

### 3. ç´¢å¼•ç®¡ç†

- **å®šæœŸæ¸…ç†**ï¼šåˆ é™¤çŸ¥è¯†åº“æˆ–æ–‡æ¡£æ—¶ï¼ŒåŒæ­¥åˆ é™¤å‘é‡ç´¢å¼•
- **å¢é‡ç´¢å¼•**ï¼šåªå¯¹æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡æ¡£é‡æ–°ç´¢å¼•
- **æ‰¹é‡æ“ä½œ**ï¼šé¿å…é¢‘ç¹çš„å°æ‰¹é‡ç´¢å¼•ï¼Œå°½é‡æ‰¹é‡å¤„ç†

## æ€§èƒ½è€ƒè™‘

1. **é¦–æ¬¡ç´¢å¼•**ï¼šé¦–æ¬¡ç´¢å¼•ä¼šä¸‹è½½ m3e-base æ¨¡å‹ï¼ˆçº¦ 400MBï¼‰ï¼Œéœ€è¦ä¸€å®šæ—¶é—´
2. **ç´¢å¼•é€Ÿåº¦**ï¼šå–å†³äºæ–‡æ¡£æ•°é‡å’Œå†…å®¹é•¿åº¦ï¼Œé€šå¸¸ 100 ä¸ªæ–‡æ¡£éœ€è¦ 1-2 åˆ†é’Ÿ
3. **æœç´¢å»¶è¿Ÿ**ï¼šå•æ¬¡æŸ¥è¯¢å»¶è¿Ÿé€šå¸¸ < 100msï¼ˆä¸å« LLM ç”Ÿæˆæ—¶é—´ï¼‰
4. **å†…å­˜å ç”¨**ï¼šæ¨¡å‹åŠ è½½éœ€è¦çº¦ 1-2GB å†…å­˜

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šç´¢å¼•å¤±è´¥

æ£€æŸ¥ï¼š
1. æ–‡æ¡£å†…å®¹æ˜¯å¦ä¸ºç©º
2. Milvus æ•°æ®åº“æ–‡ä»¶æ˜¯å¦æœ‰å†™æƒé™
3. å†…å­˜æ˜¯å¦å……è¶³ï¼ˆè‡³å°‘ 2GB å¯ç”¨ï¼‰

### é—®é¢˜ï¼šæœç´¢æ— ç»“æœ

æ£€æŸ¥ï¼š
1. çŸ¥è¯†åº“æ˜¯å¦å·²ç´¢å¼•
2. ç”¨æˆ·æƒé™æ˜¯å¦æ­£ç¡®
3. æŸ¥è¯¢æ–‡æœ¬æ˜¯å¦è¿‡çŸ­æˆ–è¿‡äºç‰¹æ®Š

### é—®é¢˜ï¼šæ€§èƒ½æ…¢

ä¼˜åŒ–ï¼š
1. ä½¿ç”¨ GPU åŠ é€Ÿï¼ˆå¦‚æœå¯ç”¨ï¼‰
2. å‡å° `top_k` å€¼
3. ä½¿ç”¨æ›´å°çš„ `max_tokens`
4. æ‰¹é‡ç´¢å¼•è€Œéé€ä¸ªç´¢å¼•

## ä¸‹ä¸€æ­¥

1. **é›†æˆ LLM**ï¼šæ·»åŠ åŸºäºæ£€ç´¢ç»“æœçš„é—®ç­”ç”Ÿæˆ
2. **è‡ªåŠ¨è§¦å‘**ï¼šæ–‡æ¡£åˆ›å»º/æ›´æ–°æ—¶è‡ªåŠ¨è§¦å‘ç´¢å¼•
3. **æ‰¹å¤„ç†**ï¼šæ·»åŠ åå°ä»»åŠ¡é˜Ÿåˆ—å¤„ç†å¤§æ‰¹é‡ç´¢å¼•
4. **å¤šæ¨¡æ€**ï¼šæ”¯æŒå›¾ç‰‡ã€è¡¨æ ¼ç­‰å¤šæ¨¡æ€å†…å®¹
5. **Rerank**ï¼šæ·»åŠ é‡æ’åºæœºåˆ¶æå‡æœç´¢è´¨é‡

## å‚è€ƒæ–‡æ¡£

- [RAG è®¾è®¡æ–‡æ¡£](DESIGN_RAG.md)
- [RAG ä½¿ç”¨æŒ‡å—](README.md)
- [AIMemos API æ–‡æ¡£](http://localhost:8000/docs)
