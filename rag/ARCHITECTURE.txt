# RAG 模块架构图

## 整体架构

┌─────────────────────────────────────────────────────────────────┐
│                    客户端 (Browser/CLI)                          │
└────────────────────────────┬────────────────────────────────────┘
                             │ HTTP/REST
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                  AIMemos FastAPI Application                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │            API Layer (/api/v1)                            │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │  │
│  │  │  Auth    │  │   KB     │  │Document  │  │   RAG    │ │  │
│  │  │  /auth   │  │  /kb     │  │  /docs   │  │  /rag ⭐ │ │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │  │
│  └──────────┬──────────┬──────────┬──────────┬──────────────┘  │
│             │          │          │          │                  │
│             ▼          ▼          ▼          ▼                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              Service Layer                             │    │
│  │  ┌────────┐  ┌────────┐  ┌──────────┐  ┌───────────┐  │    │
│  │  │  Auth  │  │   KB   │  │ Document │  │    RAG    │  │    │
│  │  │Service │  │Service │  │ Service  │  │Integration│⭐│    │
│  │  └────────┘  └────────┘  └──────────┘  └─────┬─────┘  │    │
│  └────────────────────────────────────────────────┼────────┘    │
│                                                    │             │
│  ┌─────────────────────────────────────────────────┼─────────┐  │
│  │            Repository Layer                      │         │  │
│  │  ┌────────┐  ┌────────┐  ┌──────────┐           │         │  │
│  │  │  User  │  │   KB   │  │ Document │           │         │  │
│  │  │  Repo  │  │  Repo  │  │   Repo   │           │         │  │
│  │  └────────┘  └────────┘  └──────────┘           │         │  │
│  └─────────────────────────────────────────────────┼─────────┘  │
└────────────────────────────────────────────────────┼─────────────┘
                             │                       │
                             ▼                       ▼
                    ┌────────────────┐    ┌───────────────────┐
                    │  SQLite DB     │    │  RAG Core Modules │
                    │  (aimemos.db)  │    │  ┌──────────────┐ │
                    │                │    │  │ embeddings   │ │
                    │ - Users        │    │  │ vector_store │ │
                    │ - KBs          │    │  │ ingest       │ │
                    │ - Documents    │    │  │ llm_client   │ │
                    └────────────────┘    │  └──────────────┘ │
                                          └────────┬──────────┘
                                                   │
                                                   ▼
                                          ┌───────────────────┐
                                          │  Milvus Lite DB   │
                                          │(milvus_aimemos.db)│
                                          │                   │
                                          │ - Vector Index    │
                                          │ - Metadata        │
                                          │ - Embeddings      │
                                          └───────────────────┘

## 数据流：文档索引

用户 → API(/rag/index) → RAGIntegration → KB Service (验证权限)
                                         → Document Service (获取文档列表)
                                         → Embeddings (生成向量)
                                         → Vector Store (存储到 Milvus)

## 数据流：语义搜索

用户 → API(/rag/search) → RAGIntegration → KB Service (验证权限)
                                          → Embeddings (查询向量化)
                                          → Vector Store (向量搜索 + 过滤)
                                          → 返回结果

## 权限模型

每个请求都经过：
1. JWT 认证 (get_current_user)
2. 知识库权限验证 (kb_service.get_knowledge_base)
3. 向量搜索过滤 (metadata["user_id"] == current_user)

## 核心组件说明

✅ rag/integration.py       - RAG 与知识库系统集成层
✅ aimemos/api/v1/endpoints/rag.py - REST API 端点
✅ rag/embeddings.py        - m3e-base 向量嵌入
✅ rag/vector_store.py      - Milvus Lite 向量数据库
✅ rag/ingest.py            - 文档摄取管道
✅ rag/llm_client.py        - LLM 客户端（用于后续 QA）

